执行完整的网文改编漫剧制作流程，从小说章节到最终图像生成的全自动一条龙制作。

参数：章节范围（如：1-2, 3-4）

你将作为 FullFlow Orchestrator 协调完整的制作流程，**包括自动调用ComfyUI生成所有图像**。

## 🚨🚨🚨 强制完整性规则 🚨🚨🚨

**绝对禁止的行为**：
1. ❌ **禁止复用已有文档**：不得复制或使用任何已有的剧情拆解、剧本、分镜、提示词文件
2. ❌ **禁止弄虚作假**：不得说"生成关键部分并保存"、"生成示例"、"生成代表性内容"
3. ❌ **禁止偷懒捷径**：不得从已有文件复制内容，必须从小说原文重新完整生成
4. ❌ **禁止简化流程**：不得以任何理由简化、跳过、省略任何步骤
5. ❌ **禁止部分生成**：必须生成所有剧情点、所有集数、所有镜头、所有提示词

**必须遵守的标准**：
1. ✅ 从小说原文开始，完整读取章节内容
2. ✅ 完整生成所有剧情拆解点（不遗漏任何冲突）
3. ✅ 基于剧情拆解完整生成所有单集剧本
4. ✅ 基于剧本完整生成所有分镜脚本
5. ✅ 基于分镜完整生成所有图像提示词
6. ✅ 生成所有图像、所有视频
7. ✅ 生成完整Excel文档

**违规处理**：
- 如果发现自己试图复用已有文档，必须立即停止
- 如果发现自己说"生成关键部分"，必须立即停止
- 必须删除所有复制来的内容，从零开始重新生成

## 执行步骤

### 0. 初始化时间戳输出目录 **[必需步骤 - 防止覆盖]**

**执行方式**：使用Bash工具运行 `python scripts/fullflow_orchestrator.py [章节范围]`

**重要说明**：
- 每次运行创建独立的时间戳目录：`outputs/run_YYYYMMDD_HHMMSS/`
- 确保不会覆盖之前的运行结果
- 生成配置文件：`output_paths.json` 和 `00_info.json`

**输出结构**：
```
outputs/run_20251208_143022/
├── 00_info.json              # 运行元信息
├── 01_plot_breakdown/        # 步骤1: 剧情拆解
├── 02_scripts/               # 步骤2: 单集剧本
├── 04_image_prompts/         # 步骤4: 图像提示词
├── 05_generated_images/      # 步骤5: 生成图像
├── 06_final_excel/           # 步骤6: 最终Excel
├── output_paths.json         # 路径配置
└── README.md                 # 运行说明
```

**后续步骤说明**：
- 读取生成的 `output_paths.json` 获取所有步骤的输出目录
- 所有后续步骤的输出必须写入对应的步骤目录
- 运行ID（run_id）将用于标识本次运行

### 1. 输入验证
- 检查指定章节文件是否存在于 novel/ 目录
- 验证章节范围格式正确

### 2. 剧情拆解阶段
**执行方式**：调用 breakdown-aligner Agent（可选，用于质量检查）

主流程：
- 直接基于小说章节进行剧情拆解（不通过Agent）
- 提取关键剧情点、冲突类型、情绪钩子
- 应用玄幻修仙类改编策略（等级提升、实力展示、打脸情节）
- 标注分集信息，生成剧情拆解数据
- **写入到时间戳目录**：`[run_dir]/01_plot_breakdown/plot-breakdown.md`

质量检查（可选）：
- breakdown-aligner Agent 检查剧情拆解质量（8个维度）
- 如果 FAIL，则根据反馈修改后重新检查
### 3. 单集剧本创作
**执行方式**：直接创作（不通过Agent）

主流程：
- 基于剧情拆解生成单集剧本
- 应用 webtoon-skill 知识库中的改编方法论和写作风格
- 使用 ※△【】符号的视觉化写作风格
- 每集500-800字，快节奏推进
- **写入到时间戳目录**：`[run_dir]/02_scripts/Episode-XX.md`
- 然后执行一下 /compact命令去压缩上下文（重要）

质量检查（可选）：
- webtoon-aligner Agent 检查单集剧本一致性（11个维度）
- 如果 FAIL，则根据反馈修改后重新检查

### 4. 电影分镜制作 **[关键步骤 - 调用Agent]**
**执行方式**：调用 film-shot-designer Agent

Agent 职责：
- 读取漫剧剧本（scripts/Episode-XX.md）
- 应用专业分镜规范（景别比例、运动轨迹、时长控制）
- 将剧本拆分成5-12个精确控制时长的镜头
- 为每个镜头提供具体、可视觉化的物理描述
- 生成完整的AI图像生成提示词（ai_prompt字段）
- 输出 JSON格式分镜脚本

Agent 内部调用：
- 读取 film-shot-skill 知识库（分镜方法论、模板、示例）
- 应用景别选择逻辑、运动规范、特殊场景细化标准

输出文件：
- **写入到时间戳目录**：`[run_dir]/03_storyboards/Episode-XX-Storyboard.json`（结构化数据）
- **写入到时间戳目录**：`[run_dir]/03_storyboards/Episode-XX-Storyboard.txt`（易读文本）

### 4.5 分镜质量检查 **[强制执行 - 质量闭环]**
**执行方式**：调用 shot-quality-checker Agent（强制执行，不可跳过）

**为什么必须检查**：
- 分镜质量直接决定最终图像质量
- 描述不具体 → AI生成模糊图像
- 镜头逻辑混乱 → 叙事不连贯
- 摄影参数不专业 → 视觉效果差

Agent 检查维度（7维度评分）：
1. **技术规范性**（90+分）：JSON格式、字段完整性
2. **镜头逻辑性**（85+分）：空间时间不变、动作连贯
3. **摄影专业度**（80+分）：镜头选择、角度设计、运动控制
4. **内容准确性**（90+分）：对白真实、场景还原
5. **描述清晰度**（85+分）：动作、站位、背景描述具体
6. **视觉表现力**（75+分）：构图变化、情绪传达
7. **叙事连贯性**（80+分）：情节推进、情绪弧线

质量闭环机制：
```
生成分镜 → shot-quality-checker检查
  ↓
PASS → 继续下一步
  ↓
FAIL → 根据改进建议修改 → 重新检查 → 直到PASS
```

输出：详细检查报告（含评分和改进建议）

### 5. 图像提示词生成 **[关键步骤 - 调用Agent - 强制一致性控制]**
**执行方式**：调用 image-prompt-generator Agent

Agent 职责：
- 读取分镜脚本（storyboard/Episode-XX-Storyboard.json）
- **强制读取 character-consistency-guide.md 应用角色模板**
- 识别每个镜头中的角色并强制使用统一的外貌描述
- 确保叶凡、苏灵溪等角色的服装、气质、面部特征100%一致
- 使用自然语言中文描述（无权重括号）
- 生成符合AI工具解析的完整提示词

Agent 内部调用：
- 读取 image-prompt-skill 知识库（提示词方法论、模板、示例）
- 读取 character-consistency-guide.md（角色外貌模板）

角色模板示例：
- **叶凡**：英俊成熟男子，深邃眼神如吴彦祖般锐利，文雅气质似胡歌般温润，传统白色道袍，仙风道骨气质
- **苏灵溪**：美丽中国女子，仙气飘逸如刘亦菲般清雅，灵动美感似金晨般现代，白色古装长裙，清冷高傲气质

输出文件：
- **写入到时间戳目录**：`[run_dir]/04_image_prompts/Episode-XX-Natural-Chinese-Prompts.txt`

### 5.5 提示词质量检查 **[强制执行 - 质量闭环]**
**执行方式**：调用 image-prompt-quality-checker Agent（强制执行，不可跳过）

**为什么必须检查**：
- 提示词质量直接决定AI生成图像的准确度和美观度
- 角色描述不一致 → 人物外貌前后不统一
- 提示词模糊 → AI生成效果差
- 缺少关键要素 → 画面不完整

Agent 检查维度（多维度评分）：
1. **角色一致性**：外貌、服装、气质是否100%使用模板
2. **描述完整性**：8要素结构是否完整（景别+主体+动作+服装+环境+光线+风格+特效）
3. **具体程度**：是否达到可直接生图的具体程度
4. **自然流畅性**：是否自然串联成一句话
5. **AI解析度**：是否符合主流AI工具解析逻辑

质量闭环机制：
```
生成提示词 → image-prompt-quality-checker检查
  ↓
PASS → 继续图像生成
  ↓
FAIL → 根据改进建议修改 → 重新检查 → 直到PASS
```

**关键控制点**：
- 叶凡、苏灵溪等角色必须强制使用固定描述符
- 明星参考锚定（吴彦祖+胡歌，刘亦菲+金晨）必须出现
- 服装、气质、面部特征描述绝对统一

输出：详细检查报告（含评分和改进建议）

### 6. ComfyUI图像生成 **[自动执行 - 必需步骤]**

**重要**：此步骤必须自动执行，不能跳过！

#### 执行方式
使用Bash工具运行：`python scripts/generate_all_images.py [run_dir]`

**参数说明**：
- `[run_dir]`：本次运行的时间戳目录路径（从output_paths.json读取）

#### 技术规格
- **工作流文件**：comfyui-workflows/image_z_image_turbo.json
- **ComfyUI客户端**：.claude/skills/comfyui-api-skill/comfyui_client.py
- **输入来源**：`[run_dir]/04_image_prompts/Episode-XX-Natural-Chinese-Prompts.txt`（步骤5生成）

#### 生成参数（自动配置）
```python
{
  '45.text': prompt,           # 完整图像提示词（200-300字中文）
  '44.seed': 42 + episode*100 + idx,  # 动态种子
  '44.steps': 9,               # Turbo模型优化步数
  '44.cfg': 1.0,               # CFG引导强度
  '44.sampler_name': 'euler',  # 采样器
  '44.scheduler': 'simple',    # 调度器
  '44.denoise': 1.0,           # 去噪强度
  '9.filename_prefix': 'Episode-XX-Shot-XXX'  # 文件名前缀
}
```

#### 人物一致性保证
- **100%提示词级别控制**：叶凡、苏灵溪等角色固定描述符
- **无需硬编码种子值或LoRA模型**
- 明星参考锚定（吴彦祖+胡歌，刘亦菲+金晨）

#### 批量处理流程
1. 遍历Episode 01-05的所有提示词文件
2. 解析每个文件中的"完整提示词"
3. 为每个镜头创建独立生成任务
4. 提交到ComfyUI服务器队列
5. 监控任务完成状态（5秒轮询）
6. 自动下载生成的图像
7. 重命名为标准格式：Episode-XX-Shot-XXX-Generated.png

#### 输出结构
```
[run_dir]/05_generated_images/
├── Episode-01/
│   ├── Episode-01-Shot-001.png
│   ├── Episode-01-Shot-002.png
│   └── ... (12张)
├── Episode-02/ (12张)
└── ...
```

#### 错误处理机制
1. **服务检查**：
   - 尝试连接 http://127.0.0.1:8188
   - 如失败，提示用户启动ComfyUI并等待
   - 提供启动命令：`cd path/to/ComfyUI && python main.py`

2. **智能跳过**：
   - 已存在的图像文件自动跳过
   - 避免重复生成，节省时间

3. **失败重试**：
   - 单个镜头失败不影响整体流程
   - 记录失败镜头编号供后续补生成

#### 进度监控
实时输出：
```
Processing Episode 01...
  Found 14 prompts
  Generating Shot 001...
    Prompt: 叶凡，英俊成熟男子...
    SUCCESS: Generated 1 files
  Generating Shot 002...
    ...
  Episode 01 Complete: 14/14 shots generated
```

#### 性能指标
- **单张生成时间**：5-10秒（Turbo模型）
- **62张总耗时**：约10-15分钟
- **分辨率**：768x768 (适配竖屏漫剧)
- **成功率**：预期>95%

### 7. 视频提示词生成 **[自动执行 - 电影美学增强版]**

**重要**：此步骤在图像生成后执行，为视频制作准备I2V提示词。

#### 执行方式
使用Bash工具运行：`python scripts/generate_video_prompts_v2.py [run_dir]`

**参数说明**：
- `[run_dir]`：本次运行的时间戳目录路径

**电影美学增强**：
- 整合通义万相2.2电影美学控制体系
- 9大维度精确控制：光源、光线、焦段、机位、构图、色调、饱和度、对比度、时间段
- 智能场景识别和参数映射

#### 核心功能：图生视频提示词
- **输入数据**：分镜脚本 + 图像提示词
- **应用方法论**：六要素框架（基础画面、相机运动、角色动作、环境变化、时长、质感）
- **输出格式**：结构化提示词，适配 RunwayML/Pika Labs

#### 提示词结构（六要素）

1. **基础画面**：继承图像提示词（角色、场景、光线）
2. **相机运动**：Push in/Pull back/Track/Tilt/Static + 具体距离
3. **角色动作**：分段时间轴描述（0-2秒 / 2-4秒 / 4-5秒）
4. **环境变化**：光线变化、粒子效果、自然元素
5. **时长控制**：匹配分镜 duration 字段
6. **质感要求**：电影级质感、流畅自然、无抖动

#### 输出结构
```
[run_dir]/07_video_prompts/
├── Episode-01-Video-Prompts.txt
├── Episode-02-Video-Prompts.txt
└── ...
```

**格式示例**：
```
001｜【基础画面】...｜【相机运动】镜头从1米推进至0.5米｜【角色动作】0-2秒：眼睑抬起；2-4秒：转动脖子｜【环境变化】光线闪动｜【时长】5秒｜【质感】电影级
```

### 7.5. 视频生成 **[自动执行 - 图生视频]**

**重要**：此步骤在视频提示词生成后自动执行！

#### 执行方式
使用Bash工具运行：`python scripts/generate_videos.py [run_dir]`

**前置条件**：
- 环境变量 `VIDEO_302AI_API_KEY` 已设置
- 步骤5的图像已生成（05_generated_images/）
- 步骤7的视频提示词已生成（07_video_prompts/）

#### 技术规格
- **API服务**：302.ai 万相视频生成（wan2.2-i2v-flash）
- **输入格式**：PNG图像（Base64编码） + 六要素视频提示词
- **输出格式**：MP4视频文件（720P分辨率）

#### 执行流程
1. **图像编码**：将PNG图像转换为Base64字符串
2. **批量提交**：一次性提交所有镜头的视频生成任务
3. **任务记录**：保存所有task_id到 `video_tasks.json`
4. **状态轮询**：每10秒查询一次任务状态
5. **视频下载**：任务完成后自动下载MP4文件
6. **封面提取**：从视频首帧提取封面图（用于Excel嵌入）

#### 输出结构
```
[run_dir]/08_generated_videos/
├── Episode-01/
│   ├── Episode-01-Shot-001.mp4
│   ├── Episode-01-Shot-001-thumbnail.png
│   ├── Episode-01-Shot-002.mp4
│   ├── Episode-01-Shot-002-thumbnail.png
│   └── ...
├── Episode-02/ (同上)
└── ...
```

#### 任务记录文件
```json
// [run_dir]/video_tasks.json
{
  "Episode-01-001": {
    "task_id": "3b0d3b6a-b1c7-412d-9ad6-f35ad34cd1bc",
    "status": "SUCCESS",
    "image_path": "05_generated_images/Episode-01/Episode-01-Shot-001.png",
    "prompt": "【基础画面】...｜【相机运动】...｜...",
    "video_url": "https://...",
    "video_path": "08_generated_videos/Episode-01/Episode-01-Shot-001.mp4",
    "submit_time": "2025-01-17 10:30:15",
    "complete_time": "2025-01-17 10:32:45"
  },
  ...
}
```

#### 错误处理机制
1. **API密钥检查**：脚本启动时验证环境变量
2. **失败记录**：任务失败不中断流程，记录到tasks.json
3. **超时控制**：单个任务超时2小时，整体超时可配置
4. **失败重试**：后续可手动重新运行脚本，自动跳过已完成任务

#### 进度监控
实时输出：
```
=== 第1阶段：批量提交视频生成任务 ===
Processing Episode 01...
  Shot 001: Task submitted (task_id: 3b0d...)
  Shot 002: Task submitted (task_id: 7a1f...)
  ...
共提交 62 个任务

=== 第2阶段：等待视频生成完成 ===
[10s] 进度: 5/62 完成 (8%)
[20s] 进度: 12/62 完成 (19%)
...
[180s] 进度: 62/62 完成 (100%)

=== 视频生成完成统计 ===
  成功: 60
  失败: 2
  总计: 62
```

#### 性能指标
- **单个视频生成时间**：预计2-4分钟（720P）
- **62个视频总耗时**：预计30-60分钟（异步并行）
- **文件大小**：单个视频约5-10MB
- **成功率**：预期>95%

### 8. 统一Excel输出 **[自动执行 - 必需步骤]**

**重要**：此步骤必须在视频提示词生成后执行，整合所有数据！

#### 执行方式
使用Bash工具运行：`python scripts/create_fullflow_excel_v4.py [run_dir]`

**参数说明**：
- `[run_dir]`：本次运行的时间戳目录路径（从output_paths.json读取）

#### 核心功能：全流程可视化Excel
- **图片嵌入**：每行直接显示对应镜头的生成图片
- **视频提示词**：完整的I2V提示词，可直接用于视频生成
- **剧情追溯**：从剧情点到图像到视频的完整链路
- **分镜数据**：完整的分镜参数和剧本文案

#### Excel结构（19列，中文表头，优化顺序）

**前四列核心数据**：
| 列序 | 字段名（中文） | 数据来源 | 说明 |
|-----|--------------|---------|------|
| A | **生成图片** | 图片嵌入 | 直接显示生成的图片（正确比例）|
| B | **生成视频** | 视频封面+超链接 | 视频封面图，点击打开MP4文件 |
| C | **剧情描述** | 剧情拆解 | 剧情核心内容 |
| D | **视频提示词** | 步骤7生成 | 完整I2V提示词（六要素）|

**后续列详细数据**：
| E | 集数 | 分镜JSON | Episode 01 |
| F | 镜头编号 | 分镜JSON | 001, 002... |
| G | 单集标题 | 剧本 | 万年苏醒，圣女危机 |
| H | 场景位置 | 分镜JSON | 山洞深处 |
| I | 镜头描述 | 分镜JSON | 叶凡睁开眼睛... |
| J | 对白 | 分镜JSON | "又醒了..." |
| K | 情绪 | 分镜JSON | 困倦苏醒 |
| L | 镜头类型 | 分镜JSON | Close-up |
| M | 拍摄角度 | 分镜JSON | 3/4 view |
| N | 相机运动 | 分镜JSON | Push in |
| O | 时长 | 分镜JSON | 5秒 |
| P | 图像提示词 | 图像提示词 | 完整生图提示词 |
| Q | 冲突类型 | 剧情拆解 | 世界观冲突 |
| R | 图片路径 | 文件路径 | 05_generated_images/... |

#### 可视化特性
1. **图片自动缩放**：保持宽高比，行高150px
2. **彩色表头**：深蓝色背景便于识别
3. **文本换行**：长文本自动换行显示
4. **列宽自适应**：根据内容自动调整

#### 输出文件
- **文件路径**：`[run_dir]/06_final_excel/FullFlow-Complete-Production-Data.xlsx`
- **文件大小**：约5-8MB（含嵌入图片）
- **可用性**：Excel 2010+，WPS，Google Sheets

## 数据关联策略

- 在单个对话上下文中完成所有步骤
- 记住每个剧情点对应的集数和镜头编号
- 确保分镜和图像提示词的编号一致
- 维护完整的制作链路关系

## 输出格式

最终Excel文档包含单个工作表"完整制作流程"，每行记录：
集数 | 镜头编号 | 剧情描述 | 冲突类型 | 情绪钩子 | 剧本标题 | 场景 | 镜头类型 | 拍摄角度 | 摄像机运动 | 对白 | 镜头描述 | 人物提示词 | 背景提示词 | 完整图像提示词 | 生成图像路径

## 人物一致性优化策略 **[提示词级别控制]**

### 核心原理
所有人物一致性控制都在图像提示词生成阶段完成，无需依赖硬编码参数。

### 角色模板系统
- **叶凡模板**：英俊成熟男子，深邃眼神如吴彦祖般锐利，文雅气质似胡歌般温润，传统白色道袍，仙风道骨气质
- **苏灵溪模板**：美丽中国女子，仙气飘逸如刘亦菲般清雅，灵动美感似金晨般现代，白色古装长裙，清冷高傲气质
- **可扩展性**：新角色只需在character-consistency-guide.md中添加模板即可

### 强制执行机制
- **image-prompt-generator Agent** 必须先读取角色一致性指南
- 每个镜头的角色描述100%使用模板内容
- 外貌、服装、气质描述绝对统一
- 只有动作和表情可以根据剧情调整

## 架构说明

### Agent vs Skill 的区别
- **Agent**（执行者）：独立的任务执行单元，有完整工作流程，主动调用工具和知识库
- **Skill**（知识库）：方法论、模板、示例，被动提供知识，被 Agent 读取使用

### 调用层级关系
```
FullFlow Orchestrator (总流程控制)
  │
  ├─ 步骤2: 剧情拆解（直接执行）
  │   └─ 可选：breakdown-aligner Agent 质量检查
  │
  ├─ 步骤3: 单集剧本（直接执行）
  │   ├─ 读取 webtoon-skill 知识库
  │   └─ 可选：webtoon-aligner Agent 质量检查
  │
  ├─ 步骤4: 电影分镜（调用 Agent）
  │   └─ film-shot-designer Agent
  │       └─ Agent 内部读取 film-shot-skill 知识库
  │
  └─ 步骤5: 图像提示词（调用 Agent）
      └─ image-prompt-generator Agent
          ├─ Agent 内部读取 image-prompt-skill 知识库
          └─ 强制读取 character-consistency-guide.md
```

这确保了从小说原文到最终图像生成的完整制作链路都被记录在同一行中。