# 国风动漫图像提示词生成技能

## 技能定义

专精于将剧本内容转换为适配即梦4.5的国风动漫风格中文图像提示词。

## 核心功能

- **剧本解析**：逐句分析剧本，提取场景、动作、对话
- **六要素覆盖**：场景时空、核心角色、角色关系、环境光影、氛围、构图画质
- **三层场景构建**：远景、中景、近景的层次化描述
- **角色一致性控制**：确保同一角色在不同镜头中的外观统一
- **安全内容准则**：避免不当内容，使用象征性表达

## 资源文件

### 核心文件
- `anime-style-generation.md` - 完整的动漫风格提示词生成方法
  - 即梦4.5优化规则
  - 信息优先级原则
  - 六要素公式
  - 专业光影描述
  - 角色映射表
  - 输出格式规范

### 质量保障文件（新增）
- `enhanced-rules.md` - 增强规则库
  - 场景分类模板（对话/动作/环境/群像）
  - 角色特征锁定表
  - 风格锚定词库
  - 质量检查清单

- `few-shot-examples.md` - Few-Shot示例库
  - 优秀对话示例（单角色/双角色/多角色）
  - 优秀动作示例（能量释放/战斗互动/追逐）
  - 优秀环境示例（远景/中景/近景）
  - 问题案例库（错误vs修复对比）

- `prompt_validator.py` - 提示词验证脚本
  - 六要素完整性检查
  - 角色绑定正确性检查
  - 参考图存在性检查
  - 风格锚定词检查
  - 自动修复功能

## 调用方式

### 方式一：生成提示词（使用增强规则）

调用此技能时，按顺序读取：
1. `anime-style-generation.md` - 核心规则
2. `enhanced-rules.md` - 增强规则（场景模板、角色锁定、风格锚定）
3. `few-shot-examples.md` - Few-Shot示例参考

然后：
1. 解析剧本文件
2. 根据场景类型选择对应模板
3. 应用角色特征锁定表
4. 确保包含风格锚定词
5. 输出JSON格式文件（初稿）

### 方式二：验证提示词（使用验证脚本）

```bash
# 验证并自动修复
python prompt_validator.py <初稿JSON文件> --fix

# 仅验证不修复
python prompt_validator.py <初稿JSON文件> --check-only
```

验证脚本会自动检查：
- 六要素完整性
- 角色绑定正确性
- 参考图是否存在
- 风格锚定词是否足够
- 质量约束是否包含

输出：
- 修复后的JSON文件
- 验证报告（Markdown）

## 输入要求

- 剧本文件格式（Episode-XX.md）
- 使用V-符号系统：※场景 △视觉 【对话】

## 输出格式

JSON数组，每个镜头包含：
- `shot_number`: 镜头编号
- `prompt`: 完整的中文提示词
- `has_character`: 是否包含角色
- `characters`: 角色列表
- `character_refs`: 角色参考文件列表

## 角色映射表

| 角色名 | 对应文件名 |
|--------|-----------|
| 观音菩萨 | guanyin_pusa.png |
| 慧觉 | huijue.png |
| 林玄 | linxuan.png |
| 菩提祖师 | puti_zushi.png |
| 如来佛祖 | rulai_fozu.png |
| 孙悟空 | sun_wukong.png |
| 玉帝 | yudi.png |

## 场景映射表

| 场景名 | 对应文件名 |
|--------|-----------|
| 斩仙台 | 斩仙台.png |
| 方寸山 | 方寸山.png |
| 天庭 | 天庭.png |
| 徐府 | 徐府.png |
| 云海 | 云海.png |
| 仙山 | 仙山.png |

## 提示词特点

1. **信息优先级**：开头20-30字交代主体和动作
2. **长度控制**：140-260中文字符
3. **单一连贯段落**：不分点、不换行
4. **安全准则**：避免直接暴力，使用象征表达
5. **画面洁净**：明确要求无水印、无畸形

## 使用示例

输入剧本：
```
※ 斩仙台，寒风怒号
△ 林玄跪在台上，浑身是血
【林玄】：我不服！
```

输出提示词：
```json
[
  {
    "shot_number": 1,
    "prompt": "【背景参考斩仙台】巨大斩仙台悬浮于万丈云海之上...",
    "has_character": false,
    "characters": [],
    "character_refs": ["斩仙台.png"]
  },
  {
    "shot_number": 2,
    "prompt": "【图一参考林玄】参考图1的林玄外貌与服装保持一致...",
    "has_character": true,
    "characters": ["林玄"],
    "character_refs": ["linxuan.png", "斩仙台.png"]
  }
]
```

## 注意事项

### 生成阶段
1. 必须严格遵守 anime-style-generation.md 中的规则
2. 必须参考 enhanced-rules.md 中的场景模板
3. 必须参考 few-shot-examples.md 中的示例
4. 提示词必须包含"画面干净，不要文字水印logo"
5. 角色参考必须以【图一参考角色名】开头
6. 每个镜头都要覆盖六要素（可简写但不可缺项）
7. 每条提示词必须包含至少3个风格锚定词
8. 角色描述必须详细（服装、位置、姿态、互动）

### 验证阶段
1. 生成提示词后，必须运行验证脚本
2. 检查验证报告，确认无严重问题
3. 如有无法自动修复的问题，调用质量Agent处理
4. 验证通过后再进入图像生成阶段

## 质量标准

### 必须达到的标准
- 内容对应率：≥95%（与剧本描述一致）
- 角色一致性：≥90%（同一角色不同镜头外观统一）
- 风格稳定性：≥95%（国风动漫风格统一）
- 验证通过率：100%（所有提示词必须通过验证）