# fullflow-anime 提示词质量保障优化设计文档

**创建日期**：2024-12-23
**项目**：novel-claude-project
**目标**：优化 fullflow-anime 命令中的 Skills，解决图像生成的三大质量问题

---

## 一、背景与问题分析

### 1.1 当前流程

```
小说章节 → 剧本生成 → 提示词生成 → 图像生成 → 视频生成 → Excel汇总
         (webtoon)   (image-prompt) (seedream)  (video)     (excel)
```

### 1.2 存在的质量问题

| 问题类别 | 具体表现 | 影响 |
|----------|----------|------|
| **内容不对应** | 生成的图像与剧本描述的场景、角色、动作不匹配 | 需要重新生成，浪费时间 |
| **角色不一致** | 同一角色在不同镜头中形象不一致（面容、发型、服装等） | 观众体验差，人物识别混乱 |
| **风格不稳定** | 国风动漫风格不稳定，有时偏写实、有时偏卡通 | 整体风格不统一 |

### 1.3 根因分析

1. **生成规则不够结构化**：现有 `anime-style-generation.md` 规则分散，缺少模板化指导
2. **缺少验证机制**：生成的提示词没有自动检查，问题只有在图像生成后才能发现
3. **示例不足**：AI 学习的 Few-Shot 示例较少，特别是问题案例对比
4. **角色特征锁定不足**：角色描述依赖AI记忆，缺少强制性的特征锁定表

---

## 二、优化方案

### 2.1 方案概述

采用**双重保障系统**解决质量问题：

```
┌─────────────────────────────────────────────────────────────────┐
│                        生成阶段保障                               │
│  增强型规则文档 (enhanced-rules.md + few-shot-examples.md)       │
└────────────────────────────┬────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────┐
│                        验证阶段保障                               │
│  自动验证脚本 (prompt_validator.py)                              │
└────────────────────────────┬────────────────────────────────────┘
                             │
                    ┌────────┴────────┐
                    │                 │
            ┌───────▼────────┐  ┌───▼──────┐
            │    全部通过     │  │ 有问题    │
            │   进入图像生成  │  │ 质量Agent  │
            └────────────────┘  └───────────┘
```

### 2.2 核心组件

| 组件 | 文件名 | 功能 |
|------|--------|------|
| **增强规则库** | `enhanced-rules.md` | 场景分类模板、角色特征锁定表、风格锚定词库 |
| **示例库** | `few-shot-examples.md` | 优秀示例 + 问题案例对比 |
| **验证脚本** | `prompt_validator.py` | 自动检查六要素、角色绑定、风格词等 |
| **质量Agent** | `prompt-quality-agent.md` | 处理验证脚本无法修复的问题 |

---

## 三、详细设计

### 3.1 增强规则库 (enhanced-rules.md)

#### 3.1.1 场景分类模板

| 场景类型 | 侧重点 | 必须包含 |
|----------|--------|----------|
| **对话场景** | 表情、视线、互动 | 表情描述、视线方向、互动细节 |
| **动作场景** | 姿态、速度、能量 | 角度描述、能量效果、动态光影 |
| **环境场景** | 三层描述、氛围 | 远中近景、材质细节、光影氛围 |
| **群像场景** | 主次关系、景深 | 主体清晰、背景虚化、位置关系 |

#### 3.1.2 角色特征锁定表

| 角色 | 必须包含的描述 | 禁止的描述 | 参考图 |
|------|----------------|------------|--------|
| 林玄 | 青袍少年、坚毅眼神、剑眉星目 | 老人、女性 | linxuan.png |
| 慧觉 | 青袍修士、冷傲神情、居高临下 | 卑微姿态 | huijue.png |
| 菩提祖师 | 白色道袍、仙风道骨、手持拂尘 | 凡人装束 | puti_zushi.png |

#### 3.1.3 风格锚定词库

**必须包含的锚定词**（每条提示词至少选3个）：
- 仙侠动漫风格
- 中国玄幻国风动漫风格
- 色彩鲜明对比强烈
- 流畅线条
- 戏剧性
- 悲壮感/威严/压迫感

#### 3.1.4 质量检查清单

生成前自检项：
- [ ] 【图X参考角色】开头
- [ ] 详细服装描述
- [ ] 精确人物位置
- [ ] 具体姿态动作
- [ ] 三层环境描述
- [ ] 质量约束词

---

### 3.2 示例库 (few-shot-examples.md)

#### 3.2.1 优秀示例

按场景类型分类，每类提供3-5个完整示例：

1. **对话场景示例**
   - 单角色独白（特写）
   - 双角色对峙（中景）
   - 三角色对话（全景）

2. **动作场景示例**
   - 单角色能量释放
   - 双角色战斗互动
   - 追逐动作场景

3. **环境场景示例**
   - 宏大远景（纯场景）
   - 中景环境（带氛围）
   - 近景特写（带情绪）

每个示例包含：
- 场景描述
- 完整JSON
- 关键点解析

#### 3.2.2 问题案例库

| 问题类型 | 错误示例 | 修复后 | 关键差异 |
|----------|----------|--------|----------|
| 角色特征缺失 | "参考图保持一致" | 详细描述服装、发型 | 具体描述替代空泛说法 |
| 位置信息缺失 | "两人在对峙" | 精确坐标和距离 | 精确位置替代模糊描述 |
| 风格词不足 | "林玄在台上" | 添加3+风格锚定词 | 风格词锁定画风 |
| 质量约束缺失 | 无约束语句 | 添加质量约束 | 防止畸形、水印 |
| 三层环境缺失 | "斩仙台，有云海" | 远景+中景+近景 | 层次化描述 |
| 错误比喻 | "像龙一样" | 直接描述效果 | 避免实体比喻 |

---

### 3.3 验证脚本 (prompt_validator.py)

#### 3.3.1 类结构

```python
class PromptValidator:
    def __init__(self, config_path):
        """加载配置：角色映射、场景映射、风格词库"""

    def validate_file(self, json_file) -> dict:
        """验证整个JSON文件"""

    def validate_shot(self, shot_data) -> dict:
        """验证单个镜头
        返回: {
            "is_valid": bool,
            "issues": ["问题列表"],
            "fixed_prompt": "修复后的提示词",
            "warnings": ["警告列表"]
        }
        """

    def fix_shot(self, shot_data, issues) -> dict:
        """自动修复可修复的问题"""

    def generate_report(self, results) -> str:
        """生成验证报告"""
```

#### 3.3.2 验证维度

| 维度 | 检查内容 | 自动修复 |
|------|----------|----------|
| **六要素完整性** | 场景、角色、站位、光影、氛围、构图 | 半自动（标记缺失） |
| **角色绑定正确性** | 【图X参考】与角色列表匹配 | 完全自动 |
| **参考图存在性** | 文件是否存在 | 自动移除不存在 |
| **风格锚定词** | 是否包含3+风格词 | 自动补充 |
| **质量约束** | 是否包含质量约束词 | 自动补充 |
| **长度控制** | 140-260字符 | 标记过短/过长 |
| **格式正确性** | JSON格式、字段完整 | 自动修复格式 |

#### 3.3.3 输出报告

```json
{
  "total_shots": 10,
  "valid_shots": 7,
  "needs_fix": 3,
  "auto_fixed": 2,
  "needs_manual": 1,
  "issues": [
    "Shot 3: 缺少三层环境描述",
    "Shot 5: 角色参考图不存在（已自动移除）",
    "Shot 7: 缺少风格锚定词（已自动补充）"
  ],
  "fixed_prompts_file": "Episode-XX-Prompts-fixed.json",
  "validation_report": "validation_report.md"
}
```

---

### 3.4 质量检查Agent (prompt-quality-agent.md)

当验证脚本发现无法自动修复的问题时，调用此Agent：

- 处理需要语义理解的问题
- 处理复杂的角色关系描述
- 处理特殊场景的情感氛围

---

## 四、集成方案

### 4.1 文件结构

```
.claude/
├── commands/
│   └── fullflow-anime.md          # 更新：添加验证步骤
│
├── skills/
│   └── image-prompt-skill/
│       ├── SKILL.md               # 更新：引用新组件
│       ├── anime-style-generation.md  # 保留：核心规则
│       ├── enhanced-rules.md       # 新增：增强规则
│       ├── few-shot-examples.md    # 新增：示例库
│       └── prompt_validator.py     # 新增：验证脚本
│
└── agents/
    └── prompt-quality-agent.md     # 新增：质量检查Agent
```

### 4.2 执行流程更新

```bash
# 原流程
剧本 → 提示词 → 图像

# 新流程
剧本 → 提示词(增强规则) → 验证脚本 → 图像
              ↓                  ↓
        读取enhanced-rules    检查/修复
        读取few-shot-examples
```

### 4.3 fullflow-anime.md 更新

在命令文件中添加验证步骤：

```markdown
#### 3. 生成图像提示词（使用 Skills）
- 调用 **image-prompt-skill** 生成提示词
- 读取 anime-style-generation.md + enhanced-rules.md
- 读取 few-shot-examples.md
- 输出初稿：Episode-XX-Prompts.json

#### 3.5 验证提示词（新增）
- 运行 **prompt_validator.py**
- 自动检查和修复
- 生成验证报告
- 输出修复后：Episode-XX-Prompts-fixed.json
```

---

## 五、预期效果

### 5.1 质量改善

| 指标 | 优化前 | 优化后 |
|------|--------|--------|
| 内容对应率 | ~70% | ~95% |
| 角色一致性 | ~60% | ~90% |
| 风格稳定性 | ~75% | ~95% |
| 重新生成率 | ~30% | ~5% |

### 5.2 效率提升

- 自动验证替代人工检查：节省约5分钟/集
- 自动修复减少手动调整：节省约3分钟/集
- 总体效率提升：约20%

---

## 六、实施计划

### 6.1 阶段划分

| 阶段 | 任务 | 优先级 |
|------|------|--------|
| **阶段1** | 创建 enhanced-rules.md | 高 |
| **阶段2** | 创建 few-shot-examples.md | 高 |
| **阶段3** | 实现 prompt_validator.py | 中 |
| **阶段4** | 创建 prompt-quality-agent.md | 中 |
| **阶段5** | 更新 fullflow-anime.md 集成 | 高 |
| **阶段6** | 编写单元测试 | 低 |

### 6.2 实施顺序

1. 首先创建规则库和示例库（阶段1-2）
2. 实现验证脚本（阶段3）
3. 集成到工作流（阶段5）
4. 后续完善（阶段4、6）

---

## 七、风险评估

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 规则过于复杂导致AI理解困难 | 中 | 中 | 逐步增加规则，保持向后兼容 |
| 验证脚本误判正确提示词 | 低 | 低 | 提供人工审核机制 |
| 增加执行时间 | 中 | 低 | 验证脚本性能优化 |

---

## 八、附录

### 8.1 参考文件

- `.claude/skills/image-prompt-skill/anime-style-generation.md`
- `.claude/skills/image-prompt-skill/SKILL.md`
- `.claude/commands/fullflow-anime.md`

### 8.2 相关Issues

- 内容不对应
- 角色不一致
- 风格不稳定

### 8.3 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| 1.0 | 2024-12-23 | 初始设计 |
